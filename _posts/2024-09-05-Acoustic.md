---
title: Acoustic
date: 2024-09-05 00:00:00 -500
categories: [DFIR, Network Forensics]
tags: [CyberDefenders]
---


# Table of Contents:
```c
1) Session Initiation Protocol (SIP) : what is it?
	- Why is it used?
	- What it is used for?
	- How do I use it?
	- How does it work?
2) Finding a vulnerability on the SIP: (using sipvicious)
	- The vulnerability in SIP
3) Exploitation
	- <list different subtools>
	- Putting it all together

4) Demo (see wireshark packets for this)

5) Mitigations
	- Existing mitigations
	- Some additional suggestions
	- Future Considerations

6) References
```


# Scenario

This lab takes you into the world of voice communications on the internet. VoIP is becoming the de-facto standard for voice communication. As this technology becomes more common, malicious parties have more opportunities and stronger motives to control these systems to conduct nefarious activities. This challenge was designed to examine and explore some of the attributes of the `SIP` and `RTP` protocols.


### Hypothesis:
- In this lab, it might show how attackers utilize VoIP systems to impersonate the PBX systems in an organization to conduct calls and probably vishing attacks as the calls will be traced on the compromised organization.

#### Lab Files:

```c
- "log.txt" was generated from an unadvertised, passive honeypot located on the internet such that any traffic destined to it must be nefarious. Unknown parties scanned the honeypot with a range of tools, and this activity is represented in the log file.
    - The IP address of the honeypot has been changed to "honey.pot.IP.removed". In terms of geolocation, pick your favorite city.
    - The MD5 hash in the authorization digest is replaced with "MD5_hash_removedXXXXXXXXXXXXXXXX"
    - Some octets of external IP addresses have been replaced with an "X"
    - Several trailing digits of phone numbers have been replaced with an "X"
    - Assume the timestamps in the log files are UTC.

- "Voip-trace.pcap" was created by honeynet members for this forensic challenge to allow participants to employ network analysis skills in the VOIP context.
```

As a soc analyst, analyze the artifacts and answer the questions.

# Tools:

```c
- [BrimSecurity](http://www.brimsecurity.com/)
- [Wireshark](https://www.wireshark.org/)
```

# Tags:

```c
[VoIP](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=voip)
[RTP](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=rtp)
[SIP](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=sip)
[PCAP](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=pcap)
[Wireshark](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=wireshark)
[BRIM](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=brim)
[T1123](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=t1123)
[T1046](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=t1046)
[T1190](https://cyberdefenders.org/blueteam-ctf-challenges/?tags=t1190)
```

# Questions:

## `Q1`: What is the transport protocol being used?

Querying the capabilities of the server:
![](/assets/img/Pasted image 20240726122515.png)



The protocols we need are under the UDP:

![](/assets/img/Pasted image 20240725220350.png)

-> Answer: `UDP`


## `Q2`: The attacker used a bunch of scanning tools that belong to the same suite. Provide the name of the suite.

Who's the attacker and the victim?

![](/assets/img/Pasted image 20240725143410.png)


### Structure:

```c
Attacker''s IP: 172.25.105.43 (adversary''s initial access) -> PBX system on the network
Victim''s IP: 172.25.105.40 -> Apache SIP proxy server
```

	- Hypothesis: there's a way to move laterally from 172.25.105.43 to 172.25.105.40 with the SIP protocol.


###### Software used on the SIP proxy server for PBX implementation:

![](/assets/img/Pasted image 20240726125428.png)


<u>Module version</u>:

![](/assets/img/Pasted image 20240726125515.png)

<u>Local domain</u>:

![](/assets/img/Pasted image 20240726125631.png)


Focusing on the network connections coming from the attacker:

![](/assets/img/Pasted image 20240725220902.png)

	- This is PROBABLY the attacker using the 'svmap' sub-tool from the Sipvicious.
	- I think this is more like Gobuster?


##### Authentication that happens on the server:

![](/assets/img/Pasted image 20240726123746.png)


**Note**: The scan happens in `TCP/HTTP`.

##### Checking the server's capabilities:

![](/assets/img/Pasted image 20240725221132.png)

![](/assets/img/Pasted image 20240726122653.png)

-> Answer: `sipvicious`

Link to open-source software: `https://github.com/EnableSecurity/sipvicious`

##### General usage for `sipvicious`:

```c
1) svmap -> used to find the endpoint that is using PBX

[you@box sipvicious]$ ./svmap 192.168.1.1/24

+--------------------+--------------+
| SIP Device         | User Agent   |
-------------------------------------
| 192.168.1.103:5060 | Asterisk PBX |
+--------------------+--------------+


2) svwar -> used to enumerate the extensions available on the said endpoint using PBX

[you@box sipvicious]$ ./svwar 192.168.1.103

+-----------+----------------+
| Extension | Authentication |
------------------------------
| 123       | reqauth        |
| 100       | reqauth        |
| 101       | noauth         |
+-----------+----------------+


3) svcrack -> cracking the password for extensions that DOES require password:

[you@box sipvicious]$ ./svcrack 192.168.1.103 -u 100 (uses default .txt passwords I guess)

+-----------+----------+
| Extension | Password |
------------------------
| 100       | 100      |
+-----------+----------+


-> For using a customized dictionary file:

[you@box sipvicious]$ ./svcrack 192.168.1.103 -u 123 -d dictionary.txt

+-----------+----------+
| Extension | Password |
------------------------
| 123       | secret   |
+-----------+----------+


4) Following that, you can make use of the credentials by making use of a SIP softphone of your choice.
```

	- Reference: https://github.com/enablesecurity/sipvicious/wiki/Getting-Started


#### Flow:
```c
svmap -> svwar -> svcrack -> attacker compromises the PBX systems allowing phone system impersonation?
```

- Case study: https://www.rtcsec.com/post/2010/12/11-million-euro-loss-in-voip-fraud-and/


Sub-tools inside `sipvicious`:
```c
- 'svmap' : sip scanner. When launched against ranges of IP address space, it will identify any SIP servers which it finds on the way. Also has the option to scan hosts on ranges of ports.
- 'svwar' : identifies working extension lines on a PBX. A working extension is one that can be registered. Also tells you if the extension line requires authentication or not.
- 'svcrack' : a password cracker making use of digest authentication. It is able to crack passwords on both registrar servers and proxy servers. Current cracking modes are either numeric ranges or words from dictionary files.
- 'svreport' : able to managesessions created by the rest of the tools and export to pdf, xml, csv and plaintext.
- 'svcrash' : responds to svwar and svcrack SIP messages with a message that causes old version to crash
```


## `Q3`: What is the `User-Agent` of the victim system?

Shows that this is VoIP:

![](/assets/img/Pasted image 20240725221312.png)

-> Answer: `Asterisk PBX 1.6.0.10-FONCORE-r40`


What is PBX?
-> a telephone system that allows extension phones in one office to connect to the telephone network in another office. Basically a way to network different telephone networks.


## `Q4`:  Which tool was only used against the following extensions: `100`,`101`,`102`,`103`, and `111`? (This is found in the `log.txt` file)

Clues: let's try to filter on the packets using the `SIP` protocol first and `statistics` on it

![](/assets/img/Pasted image 20240725224439.png)


***SIP requests***:

![](/assets/img/Pasted image 20240725224508.png)


##### Attacker finding a target on the network after running `svmap`: (Note that you should see a response coming from the target machine but on source port `5060` or `5061 (TLS)` which is in UDP and NOT in TCP.)

![](/assets/img/Pasted image 20240726105006.png)

	- Which SIP request are used when using 'svmap' subtool?


***Note that there is only extensions `100`, `555` and `1000` in the Wireshark pcap***.

Digging into this stream:
```c
Sequence of methods used by attacker:
1) REGISTER ['request'] <-> SIP/2.0 200 OK ['response'] : attacker impersonates the extension assuming it has its credentials (for authentication)
2) SUBSCRIBE ['request'] <-> SIP/2.0 404 Not found (no mailbox) ['response'] : for subscribing on a mailbox (in the case below, it doesn''t have one)
3) INVITE ['request'] <-> SIP/2.0 100 Trying then SIP/2.0 200 OK ['response'] : invite an endpoint to a call
4) ACK ['request'] : acknowledges the phone call about to start

<phone-call happens here as describe in the RFC 3261>

5) BYE : ends the phone call
```


Successful impersonation of extension `555`: (Goal: find the packets that show how the credentials for extension `555` was extracted using `sipvicious`)

![](/assets/img/Pasted image 20240726111829.png)

![](/assets/img/Pasted image 20240726111850.png)

![](/assets/img/Pasted image 20240726111909.png)

![](/assets/img/Pasted image 20240726111933.png)

![](/assets/img/Pasted image 20240726112003.png)

![](/assets/img/Pasted image 20240726112019.png)


This is the packets for the call happening:

![](/assets/img/Pasted image 20240726123207.png)


<u>Content of the conversation</u>:

![](/assets/img/Pasted image 20240726123301.png)

	- It is either encoded or encrypted.


<u>End of the conversation</u>:

![](/assets/img/Pasted image 20240726123458.png)


##### Showing how the credentials for extension `555` was extracted:

![](/assets/img/Pasted image 20240726124124.png)

	- Found the password on the webserver for extension '555'.
	- How does this indicate its 'svcrack' that was used for it?


Found in the `sip_custom.conf` file which is widely used in PBX systems:

![](/assets/img/Pasted image 20240726130911.png)


-> Answer: `svcrack`

<u>Sub-questions</u>:
```c
- How exactly is the svcrack.py subtool used on these extensions? Is it via HTTP? UDP?
```


##### Checking all other `HTTP 200 OK` response:

![](/assets/img/Pasted image 20240726124719.png)


Saving all the responses on a file: `File > Export Objects > HTTP`

![](/assets/img/Pasted image 20240726124859.png)


<u>Query used</u>:

```c
http.response.code == 200
```


Other findings for the `trixbox` system:

![](/assets/img/Pasted image 20240726131328.png)


Apache OS PBS proxy server:

![](/assets/img/Pasted image 20240726131443.png)



## `Q5`: Which extension on the honeypot does NOT require authentication?

For this one, try to parse the extensions that was accepted immediately:

![](/assets/img/Pasted image 20240726135042.png)

If you look up the string `Authorization`, you will NOT get the username `100` from the list of extensions: `100,101,102,103` and `111`.

-> Answer: `100`


## `Q6`: How many extensions were scanned in total?

What do we know about the scan?

```c
- What tools was used for scanning: 'sipvicious'
- Is there something specific about this tool on the packet capture? : 'User-Agent: friendly-scanner' at sixth line for each block
- What about the extensions? -> It seems to be a number from 100 -> a four digit number 9999 probably
- What about the destination? -> It should be the honeypot
- Contact line also contains the caller ID''s extension -> since the extension exists on lines 'Contact' and 'Request(INVITE,SUBSCRIBE,etc.)' line, we want to avoid duplication by grepping on the 'Contact' part only.
```

<u>Query</u>:

```c
cat log.txt | grep 'User-Agent: friendly-scanner' -A2 | grep -i 'honey' | grep -v Contact | uniq | wc -l
```

	- It will output 2657. However, on the last 5 lines, it will duplicate for extensions 100,101,102,103,and 111

-> Answer: `2652`

## `Q7`: There is a trace for a real SIP client. What is the corresponding user-agent? (two words, once space in between)

Parse the `log.txt` file using grep:

```c
grep -Ei 'User-Agent:' log.txt | uniq
```

	- This will output all User-Agents found.


Output:
```c
User-Agent: friendly-scanner
User-Agent: Zoiper rev.6751
```

Log:

```c
Source: 89.42.194.X:47357
Datetime: 2010-05-05 10:01:27.633156

Message:

INVITE sip:00112524021XXXX@honey.pot.IP.removed;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 89.42.194.X:47357;branch=z9hG4bK-d8754z-68f9184b4bda688f-1---d8754z-
Max-Forwards: 70
Contact: <sip:100@89.42.194.X:47357;transport=UDP>
To: <sip:00112524021XXXX@honey.pot.IP.removed;transport=UDP>
From: "Unknown"<sip:100@honey.pot.IP.removed;transport=UDP>;tag=X_removed
Call-ID: ZGVlNmY2N2M0MDg5YzFjNTY3YTMzMDliOWI4YzZiNzI.
CSeq: 1 INVITE
Allow: INVITE, ACK, CANCEL, BYE, NOTIFY, REFER, MESSAGE, OPTIONS, INFO, SUBSCRIBE
Content-Type: application/sdp
User-Agent: Zoiper rev.6751
Content-Length: 330

v=0
o=Zoiper_user 0 0 IN IP4 89.42.194.X
s=Zoiper_session
c=IN IP4 89.42.194.X
t=0 0
m=audio 52999 RTP/AVP 3 0 8 110 98 101
a=rtpmap:3 GSM/8000
a=rtpmap:0 PCMU/8000
a=rtpmap:8 PCMA/8000
a=rtpmap:110 speex/8000
a=rtpmap:98 iLBC/8000
a=fmtp:98 mode=30
a=rtpmap:101 telephone-event/8000
a=fmtp:101 0-15
a=sendrecv



-------------------------
Source: 89.42.194.X:47357
Datetime: 2010-05-05 10:01:48.058434

Message:

REGISTER sip:honey.pot.IP.removed;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 89.42.194.X:47357;branch=z9hG4bK-d8754z-6d7ce863ce784e7d-1---d8754z-
Max-Forwards: 70
Contact: <sip:100@89.42.194.X:47357;rinstance=40ab3fc74606e4e6;transport=UDP>;expires=0
To: "Unknown"<sip:100@honey.pot.IP.removed;transport=UDP>
From: "Unknown"<sip:100@honey.pot.IP.removed;transport=UDP>;tag=X_removed
Call-ID: NDZlYTcyYzQwYWVkYTg5NTAyMjZiNGE2ZjBiY2ZiOTA.
CSeq: 2 REGISTER
Allow: INVITE, ACK, CANCEL, BYE, NOTIFY, REFER, MESSAGE, OPTIONS, INFO, SUBSCRIBE
User-Agent: Zoiper rev.6751
Allow-Events: presence
Content-Length: 0
-------------------------
```

	- Notice that this User agent relates to the actual VoIP that was used to impersonate the user of the given extension and make phone calls on their behalf through the PBX system. It essentially uses the victim''s phone number by the attacker on behalf of the victim.
	- Actual calls for impersonation uses the Zoiper softphone. This is a free VoIP softphone.


-> Answer: `Zoiper rev.6751`


## `Q8`: Multiple real-world phone numbers were dialed. What was the most recent 11-digit number dialed from extension 101?

-> First, find the user agent: `Zoiper rev.6751`

![](/assets/img/Pasted image 20240727191508.png)

	- However, we want the number that was dialed. This should be on an INVITE request.


<u>Block of lines of interest</u>: From the current state above, search up '`INVITE`' keyword to downward direction

![](/assets/img/Pasted image 20240727191703.png)

```c
Source: 89.42.194.X:47357
Datetime: 2010-05-05 10:00:11.493635

Message:

INVITE sip:900114382089XXXX@honey.pot.IP.removed;transport=UDP SIP/2.0
Via: SIP/2.0/UDP 89.42.194.X:47357;branch=z9hG4bK-d8754z-e0b5a6bd1d792436-1---d8754z-
Max-Forwards: 70
Contact: <sip:101@89.42.194.X:47357;transport=UDP>
To: <sip:900114382089XXXX@honey.pot.IP.removed;transport=UDP>
From: "Unknown"<sip:101@honey.pot.IP.removed;transport=UDP>;tag=X_removed
Call-ID: Y2Y4NjJiYzJjYzVkNzhhNTRmNjRmYWZhMjFmM2FlZTc.
CSeq: 1 INVITE
Allow: INVITE, ACK, CANCEL, BYE, NOTIFY, REFER, MESSAGE, OPTIONS, INFO, SUBSCRIBE
Content-Type: application/sdp
User-Agent: Zoiper rev.6751
Content-Length: 330
```

	- On this first instance, the number that was dialed by extension '101' from 89.42.194.X:47357 is '900114382089'
	- At this point, we may want to find instances that exists AFTER this one


This is the most recent dialed number:

![](/assets/img/Pasted image 20240727191917.png)

<u>Query</u>:
```c
grep -Ei 'From: "Unknown"<sip:101' log.txt -B8 | grep INVITE
```

	- Extracts the regular expression enclosed in the single quotations.
	- '-B8' : this option tells 'grep' to show 8 lines of leading context before each matching line. Essentially, it includes the 8 lines preceding each match in the output.
	- Since we want to get the real-world phone numbers, it has to have the user agent of 'Zoiper rev.6751'


<u>Output</u>:
```c
INVITE sip:<number1>xxxx@honey.pot.IP.removed;transport=udp SIP/2.0 => Oldest
INVITE sip:<number2>xxxx@honey.pot.IP.removed;transport=udp SIP/2.0
INVITE sip:<number3>xxxx@honey.pot.IP.removed;transport=udp SIP/2.0 => Most recent
```


-> Answer: `00112524021`


## `Q9`: What are the default credentials used in the attempted `basic authentication`? (format is `username:password`)

Check out this packet:

![](/assets/img/Pasted image 20240727192119.png)

Follow this stream:

![](/assets/img/Pasted image 20240727192201.png)

![](/assets/img/Pasted image 20240727192219.png)

	- This is the default credentials for the Trixbox system.

-> Answer: `maint:password`


## `Q11`: Which codec does the RTP stream use? (3 words, 2 spaces in between)

Its in the payload type:

![](/assets/img/Pasted image 20240727193817.png)


-> Answer: `ITU-T G.711 PCMU`


## `Q12`: How long is the sampling time (in milliseconds)?

Search up the `sampling time` for the Payload type above: `ITU-T G.711 PCMU`. It's called '***Algorithmic delay***'

-> Answer: `0.125ms`


## `Q13`: What was the password for the account with username `555`?

##### Showing how the credentials for extension `555` was extracted:

![](/assets/img/Pasted image 20240726124124.png)

	- Found the password on the webserver for extension '555'.
	- How does this indicate its 'svcrack' that was used for it?

-> Answer: `1234`


## `Q14`: Which RTP packet header field can be used to reorder out of sync RTP packets in the correct sequence?

-> Answer: `timestamp`


## `Q15`: The trace includes a secret hidden message. Can you hear it?

Go to `Telephony > RTP Streams` 

Select both and then `Analyze`:

![](/assets/img/Pasted image 20240726135908.png)


A window will popup then click on "`Play Streams`":

![](/assets/img/Pasted image 20240726135940.png)


Click the play on the bottom left hand side:

![](/assets/img/Pasted image 20240726140040.png)

	- You will hear the conversation made by the attacker on the compromised server that it invited in the call via user '555' onto user '1000'.


`->` Answer: `Mexico`

----
# Attack Chain

```c
1) Scan with NMAP on the PBX system''s server
2) Find configuration files in the PBX system''s Apache webserver for credentials
3) Run svwar to figure out which extension needs authentication and which does not
4) Use svcrack to register to the compromised extension
5) Attacker make phone calls on behalf of the victim''s phone number using actual VoIP number via Zoiper rev
6) With the prevalence of AI nowadays, attackers can do vishing attacks with the help of voice cloning and the receiver of the call would not know that they are talking to an attacker rather than their family or something.
```

	- Question: Can attacker relay the call received by the victim to themselves before the victim sees the call? If so, they can intercept the phone call and messages and possibly MiTM-ed it?
