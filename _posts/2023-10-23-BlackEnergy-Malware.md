---
title: BlackEnergy Malware
date: 2023-10-23 00:00:00 -500
categories: [CCD, Memory Forensics]
tags: [CCD]
---


# Scenario:

A multinational corporation has been hit by a cyber attack that has led to the theft of sensitive data. The attack was carried out using a variant of the `BlackEnergy v2 malware` that has never been seen before. The company's security team has acquired a memory dump of the infected machine, and they want you, as a soc analyst, to analyze the dump to understand the attack scope and impact.

# Questions:

- `Q1`: Which volatility profile would be best for this machine?

Getting general information about this memory:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw imageinfo
```

![](/assets/img/Pasted image 20241023050040.png)

<u>From Windows VM</u>:


Executing `imageinfo` to get the profile for this image with the assumption that the profile was the first suggestion `WinXPSP2x86` with the use of `kdbgscan`:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 kdbgscan
```

![](/assets/img/Pasted image 20241023050447.png)

	- KdCopyDataBlock address is not here. We need that for `pslist` but I guess we can use pslist without it.

<u>Answer</u>:
```c
WinXPSP2x86
```



- `Q2`: How many processes were running when the image was acquired?

Suspicious processes listed with `pslist`: Note that this uses the `PsActiveProcessHead` to list all of the process nodes in the linked list
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 pslist
```

![](/assets/img/Pasted image 20241023051152.png)

	- rootkit.exe
	- cmd.exe
	- notepad.exe (3x)
	- DumpIt.exe
	- Notice that there are 6 processes that does NOT have a threat. Meaning, they are inactive. Note that a process has to have atleast 1 thread for it to be considered active.


Checking process' parent-child relationships:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 pstree
```

![](/assets/img/Pasted image 20241023052819.png)

	- It says, there should be more than 25 processs in here. But with SIFT idk why it only shows this much.


<u>Answer</u>:
```c
19
```


- `Q3`: What is the process ID of `cmd.exe`?

-> Look above.

<u>Answer</u>:
```c
1960
```


- `Q4`: What is the name of the most suspicious process?

Using `verbose` mode for more information:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 pstree -v
```

![](/assets/img/Pasted image 20241023053230.png)
![](/assets/img/Pasted image 20241023053309.png)
![](/assets/img/Pasted image 20241023053330.png)

	- Attacker's path: explorer.exe -> rootkit.exe -> cmd.exe
	- Another process that stood out is 'alg.exe'


<u>Answer</u>:
```c
rootkit.exe
```


- `Q5`: Which process shows the highest likelihood of code injection?

Let's check any hidden process as hinted by the `rootkit.exe`:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 psxiew -v
```

All of the process listed from `pslist` was shown to us:
![](/assets/img/Pasted image 20241023054316.png)


Digging into the suspicious/malicious process: (`rootkit.exe` , `cmd.exe` and `alg.exe` inside `System32`)
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP2x86 psinfo
```

***`rootkit.exe`***:
![](/assets/img/Pasted image 20241023061408.png)
![](/assets/img/Pasted image 20241023062102.png)

	- There's no suspected memory regions either


***`cmd.exe`***:
![](/assets/img/Pasted image 20241023061530.png)

	- Notice that there are no memory information for both cmd.exe and rootkit.exe while all other process has one.

![](/assets/img/Pasted image 20241023062139.png)

	- There's no suspected memory regions either


***`alg.exe`***:
![](/assets/img/Pasted image 20241023062555.png)


<u>Answer</u>: Look for the process that is active. `svchost.exe` is used by services so its very likely
```c
svchost.exe
```


- Q6: There is an odd file referenced in the recent process. Provide the full path of that file.

Enumerating files for each `svchost.exe`:

```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP3x86 handles -p 968 -t file
```

PID: 880
![](/assets/img/Pasted image 20241023073840.png)

PID: 968
![](/assets/img/Pasted image 20241023073613.png)


PID: 1060
![](/assets/img/Pasted image 20241023073939.png)

PID: 1108
![](/assets/img/Pasted image 20241023074001.png)

PID: 1156
![](/assets/img/Pasted image 20241023074026.png)


<u>Answer</u>:
```c
\Device\HarddiskVolume1\WINDOWS\system32\drivers\str.sys

which is

C:\Windows\system32\drivers\str.sys
```


- Q7: What is the name of the injected dll file loaded from the recent process?


Using `ldrmodules`, not only shows the DLL linked, but also the DLL that got removed from the process as typical Process Injection technique:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP3x86 -p 880 ldrmodules
```

This highlighted dll shows that it was once in the process but was unlinked. This is very suspicious especially for an active process:
![](/assets/img/Pasted image 20241023080026.png)

<u>Answer</u>:
```c
msxml3r.dll
```


- Q8: What is the base address of the injected dll?

Command:
```c
vol.py -f CYBERDEF-567078-20230213-171333.raw --profile=WinXPSP3x86 -p 880 malfind
```

![](/assets/img/Pasted image 20241023075337.png)

	- Malfind shows the memory address where the injected code will start


<u>Answer</u>:
```c
0x980000
```


